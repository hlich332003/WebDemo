<div class="cart-container">
  <h1>Giỏ hàng của bạn</h1>

  <ng-container *ngIf="cartService.cartItems$ | async as cartItems">
    @if (cartItems.length === 0) {
      <div class="alert alert-warning">Giỏ hàng của bạn đang trống.</div>
    } @else {
      <div class="cart-header">
        <div class="select-all">
          <label for="selectAll">Chọn tất cả</label>
          <input type="checkbox" [checked]="isAllSelected()" (change)="toggleSelectAll($event)" id="selectAll" />
        </div>
      </div>

      <div class="cart-items">
        @for (item of cartItems; track item.product.id) {
          <div class="cart-item" [class.selected]="item.selected">
            <img
              [src]="item.product.imageUrl || 'content/images/default-product.svg'"
              [alt]="item.product.name"
              class="item-image"
              loading="lazy"
              (error)="onImageError($event)"
            />
            <div class="item-details">
              <h4 class="item-name">{{ item.product.name }}</h4>
              <p class="item-price">{{ formatPrice(item.product.price) }}</p>
              @if (item.product.quantity !== null && item.product.quantity !== undefined) {
                @if (item.product.quantity === 0) {
                  <p class="text-danger fw-bold">❌ Hết hàng</p>
                } @else if (item.product.quantity < 10) {
                  <p class="text-warning">⚠️ Chỉ còn {{ item.product.quantity }} sản phẩm</p>
                } @else {
                  <p class="text-success">✓ Còn {{ item.product.quantity }} sản phẩm</p>
                }
              } @else {
                <p class="text-muted">Còn hàng</p>
              }
            </div>
            <div class="item-quantity-controls">
              <button
                (click)="decreaseQuantity(item.product.id, item.quantity)"
                class="btn btn-secondary btn-sm"
                [disabled]="item.quantity <= 1 || (item.product.quantity !== null && item.product.quantity === 0)"
              >
                -
              </button>
              <input
                type="number"
                [value]="item.quantity"
                (blur)="onQuantityBlur(item.product.id, $event)"
                (keydown.enter)="onQuantityBlur(item.product.id, $event)"
                min="1"
                [max]="item.product.quantity ?? 999"
                [disabled]="item.product.quantity !== null && item.product.quantity === 0"
                class="quantity-input"
                placeholder="Nhập số lượng"
              />
              <button
                (click)="increaseQuantity(item.product.id, item.quantity)"
                class="btn btn-secondary btn-sm"
                [disabled]="
                  item.quantity >= (item.product.quantity ?? 999) || (item.product.quantity !== null && item.product.quantity === 0)
                "
              >
                +
              </button>
            </div>
            <div class="item-total-price">
              <span>{{ formatPrice((item.product.price ?? 0) * item.quantity) }}</span>
            </div>
            <div class="item-actions">
              <button
                type="button"
                (click)="toggleWishlist(item.product, $event)"
                class="btn btn-sm wishlist-btn"
                [class.btn-danger]="isInWishlist(item.product.id!)"
                [class.btn-outline-secondary]="!isInWishlist(item.product.id!)"
                title="{{ isInWishlist(item.product.id!) ? 'Xóa khỏi yêu thích' : 'Thêm vào yêu thích' }}"
              >
                <fa-icon icon="heart" [class.text-danger]="!isInWishlist(item.product.id!)"></fa-icon>
              </button>
              <button (click)="remove(item.product.id)" class="btn btn-danger btn-sm">Xóa</button>
            </div>
            <div class="item-select">
              <input type="checkbox" [checked]="item.selected" (change)="toggleSelection(item.product.id!)" />
            </div>
          </div>
        }
      </div>

      <div class="cart-summary">
        <h3>
          Tổng cộng ({{ (cartService.selectedItems$ | async)?.length }} sản phẩm):
          <span class="total-price">{{ formatPrice((cartService.selectedTotalPrice$ | async) ?? 0) }}</span>
        </h3>
        <button
          (click)="proceedToCheckout()"
          class="btn btn-primary btn-lg"
          [disabled]="(cartService.selectedItems$ | async)?.length === 0"
        >
          Mua hàng
        </button>
      </div>
    }
  </ng-container>
</div>
