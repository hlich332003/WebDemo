<div>
  <h2>
    <span id="order-management-page-heading" data-cy="orderManagementPageHeading">Quản lý đơn hàng</span>

    <div class="d-flex justify-content-end">
      <button class="btn btn-info me-2 rounded-pill" (click)="loadAll()" [disabled]="isLoading()">
        <span>Làm mới danh sách</span>
      </button>
    </div>
  </h2>

  <!-- Search Box -->
  <div class="row mb-3">
    <div class="col-md-4">
      <div class="input-group">
        <span class="input-group-text"><fa-icon icon="search"></fa-icon></span>
        <input
          type="text"
          class="form-control"
          placeholder="Mã đơn hàng..."
          [(ngModel)]="searchOrderCode"
          (ngModelChange)="onSearchChange()"
        />
      </div>
    </div>
    <div class="col-md-4">
      <div class="input-group">
        <span class="input-group-text"><fa-icon icon="phone"></fa-icon></span>
        <input
          type="text"
          class="form-control"
          placeholder="Số điện thoại khách..."
          [(ngModel)]="searchPhone"
          (ngModelChange)="onSearchChange()"
        />
      </div>
    </div>
    <div class="col-md-2">
      @if (searchOrderCode() || searchPhone()) {
        <button class="btn btn-outline-secondary w-100" type="button" (click)="clearSearch()">
          <span>Xóa bộ lọc</span>
        </button>
      }
    </div>
  </div>

  @if (orders()) {
    <div class="table-responsive">
      <table class="table table-striped table-bordered table-hover" aria-describedby="order-management-page-heading">
        <thead>
          <tr jhiSort [(sortState)]="sortState" (sortChange)="transition($event)">
            <th scope="col" jhiSortBy="id"><span>ID</span></th>
            <th scope="col" jhiSortBy="orderCode"><span>Mã đơn</span></th>
            <th scope="col" jhiSortBy="orderDate"><span>Ngày đặt</span></th>
            <th scope="col" jhiSortBy="customerFullName">
              <span>Tên khách hàng</span>
            </th>
            <th scope="col" jhiSortBy="customerPhone">
              <span>SĐT khách hàng</span>
            </th>
            <th scope="col" jhiSortBy="totalAmount"><span>Tổng tiền</span></th>
            <th scope="col" jhiSortBy="status"><span>Trạng thái</span></th>
            <th scope="col"></th>
          </tr>
        </thead>
        <tbody>
          @for (order of orders(); track trackId($index, order)) {
            <tr [class.table-active]="selectedOrder()?.id === order.id">
              <td>{{ order.id }}</td>
              <td>
                <strong>{{ order.orderCode }}</strong>
              </td>
              <td>{{ formatOrderDate(order.orderDate) }}</td>
              <td>{{ order.customerFullName }}</td>
              <td>{{ order.customerPhone }}</td>
              <td>
                {{ order.totalAmount | currency: 'VND' : 'symbol' : '1.0-0' }}
              </td>
              <td>
                <span
                  class="badge"
                  [ngClass]="{
                    'bg-warning': order.status === 'PENDING',
                    'bg-info': order.status === 'PROCESSING',
                    'bg-primary': order.status === 'SHIPPED',
                    'bg-success': order.status === 'DELIVERED' || order.status === 'COMPLETED',
                    'bg-danger': order.status === 'CANCELLED',
                  }"
                  >{{ getStatusText(order.status) }}</span
                >
              </td>
              <td class="text-end">
                <div class="btn-group">
                  @if (order.status === 'PENDING') {
                    <button type="button" (click)="updateStatus(order, 'PROCESSING')" class="btn btn-warning btn-sm rounded-pill me-1">
                      <span>Xác nhận</span>
                    </button>
                  } @else if (order.status === 'PROCESSING') {
                    <button type="button" (click)="updateStatus(order, 'SHIPPED')" class="btn btn-primary btn-sm rounded-pill me-1">
                      <span>Giao hàng</span>
                    </button>
                  } @else if (order.status === 'SHIPPED') {
                    <button type="button" (click)="updateStatus(order, 'COMPLETED')" class="btn btn-success btn-sm rounded-pill me-1">
                      <span>Hoàn thành</span>
                    </button>
                  }

                  <button type="button" (click)="toggleOrderDetail(order)" class="btn btn-info btn-sm rounded-pill me-1">
                    <span>{{ selectedOrder()?.id === order.id ? 'Ẩn' : 'Chi tiết' }}</span>
                  </button>

                  <!-- FIX: Chỉ hiện nút Hủy, không hiện nút Xóa -->
                  @if (order.status !== 'CANCELLED' && order.status !== 'COMPLETED') {
                    <button type="button" (click)="cancelOrder(order.id!)" class="btn btn-danger btn-sm rounded-pill">
                      <span>Hủy đơn</span>
                    </button>
                  }
                </div>
              </td>
            </tr>
            @if (selectedOrder()?.id === order.id) {
              <tr>
                <td colspan="8" class="p-0">
                  <div class="order-detail-container p-3 bg-light">
                    <div class="row">
                      <div class="col-md-6">
                        <h6 class="fw-bold">Thông tin khách hàng</h6>
                        <p class="mb-1"><strong>Tên:</strong> {{ order.customerFullName }}</p>
                        <p class="mb-1"><strong>SĐT:</strong> {{ order.customerPhone }}</p>
                        <p class="mb-1">
                          <strong>Email:</strong>
                          {{ order.customerEmail || 'N/A' }}
                        </p>
                        <p class="mb-1"><strong>Địa chỉ:</strong> {{ order.deliveryAddress }}</p>
                        @if (order.notes) {
                          <p class="mb-1"><strong>Ghi chú:</strong> {{ order.notes }}</p>
                        }
                      </div>
                      <div class="col-md-6">
                        <h6 class="fw-bold">Chi tiết sản phẩm</h6>
                        @if (order.items && order.items.length > 0) {
                          <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                              <thead>
                                <tr>
                                  <th>Sản phẩm</th>
                                  <th>SL</th>
                                  <th>Đơn giá</th>
                                  <th>Tổng</th>
                                </tr>
                              </thead>
                              <tbody>
                                @for (item of order.items; track item.id) {
                                  <tr>
                                    <td>{{ item.productName }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>
                                      {{ item.price | currency: 'VND' : 'symbol' : '1.0-0' }}
                                    </td>
                                    <td>
                                      {{ item.quantity! * item.price! | currency: 'VND' : 'symbol' : '1.0-0' }}
                                    </td>
                                  </tr>
                                }
                              </tbody>
                            </table>
                          </div>
                        } @else {
                          <p class="text-muted">Không có sản phẩm</p>
                        }
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-center" *ngIf="orders()?.length === 0">
      <div class="alert alert-warning">Không có đơn hàng nào được tìm thấy.</div>
    </div>
  }

  @if (orders() && orders()!.length > 0) {
    <div>
      <div class="d-flex justify-content-center">
        <jhi-item-count [params]="{ page, totalItems: totalItems(), itemsPerPage }" />
      </div>

      <div class="d-flex justify-content-center">
        <ngb-pagination
          [collectionSize]="totalItems()"
          [(page)]="page"
          [pageSize]="itemsPerPage"
          [maxSize]="5"
          [rotate]="true"
          [boundaryLinks]="true"
          (pageChange)="transition()"
        ></ngb-pagination>
      </div>
    </div>
  }
</div>
