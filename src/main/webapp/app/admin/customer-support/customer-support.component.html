<div class="customer-support-container">
  <div class="header">
    <h2><fa-icon icon="comments"></fa-icon> Hỗ trợ khách hàng</h2>
    <div class="connection-status" [class.connected]="isConnected">
      <fa-icon [icon]="isConnected ? 'circle' : 'circle-xmark'"></fa-icon>
      {{ isConnected ? 'Đã kết nối' : 'Mất kết nối' }}
    </div>
  </div>

  <div *ngIf="!isConnected" class="alert alert-danger mt-2">
    <fa-icon icon="exclamation-triangle"></fa-icon>
    <strong>Mất kết nối máy chủ!</strong> Vui lòng kiểm tra mạng hoặc tải lại trang.
  </div>

  <div class="support-layout">
    <div class="conversations-sidebar">
      <div class="sidebar-header">
        <div class="tabs">
          <button class="tab-btn" [class.active]="activeTab === 'CHAT'" (click)="setActiveTab('CHAT')">
            <fa-icon icon="comments"></fa-icon> Chat trực tiếp
          </button>
          <button class="tab-btn" [class.active]="activeTab === 'TICKET'" (click)="setActiveTab('TICKET')">
            <fa-icon icon="envelope"></fa-icon> Tickets
          </button>
        </div>
        <span class="conversation-count">{{ conversations.length }}</span>
      </div>

      <div class="conversations-list">
        <div *ngIf="conversations.length === 0" class="empty-state">
          <fa-icon [icon]="activeTab === 'CHAT' ? 'comments' : 'envelope'"></fa-icon>
          <p>Chưa có {{ activeTab === 'CHAT' ? 'cuộc trò chuyện' : 'ticket' }} nào.</p>
        </div>

        <div
          *ngFor="let convo of conversations; trackBy: trackByConversationId"
          class="conversation-item"
          [class.active]="selectedConversation?.id === convo.id"
          (click)="selectConversation(convo)"
        >
          <div class="conversation-avatar"><fa-icon icon="user"></fa-icon></div>
          <div class="conversation-info">
            <div class="conversation-name">{{ convo.userIdentifier }}</div>
            <div class="conversation-preview">{{ convo.lastMessageAt | date: 'short' }}</div>
          </div>
          <span *ngIf="convo.unreadCount > 0" class="unread-badge">{{ convo.unreadCount }}</span>
        </div>
      </div>
    </div>

    <div class="chat-area">
      <div *ngIf="selectedConversation; else noSelection" class="chat-content-wrapper">
        <div class="chat-header">
          <div class="chat-user-info">
            <fa-icon icon="user" />
            <div>
              <div class="chat-user-name">{{ selectedConversation.userIdentifier }}</div>
              <div class="chat-ticket-info">
                <fa-icon [icon]="activeTab === 'CHAT' ? 'comments' : 'envelope'"></fa-icon>
                {{ activeTab === 'CHAT' ? 'Cuộc trò chuyện' : 'Ticket' }} #{{ selectedConversation.id }} - {{ selectedConversation.status }}
              </div>
            </div>
          </div>
          <div class="chat-actions">
            <button class="btn btn-sm btn-danger" (click)="closeConversation(selectedConversation!.id)">
              <fa-icon icon="times-circle"></fa-icon> Đóng
            </button>
          </div>
        </div>

        <div class="chat-messages" #chatMessagesContainer (scroll)="onUserScroll()">
          <div
            *ngFor="let message of messages; trackBy: trackByMessageId"
            class="message"
            [ngClass]="{
              'from-admin': message.isFromAdmin,
              'from-user': !message.isFromAdmin,
            }"
          >
            <div class="message-avatar">
              <fa-icon [icon]="message.isFromAdmin ? 'user-tie' : 'user'"></fa-icon>
            </div>
            <div class="message-content">
              <div class="message-sender">
                {{ message.isFromAdmin ? (adminUser?.email | slice: 0 : 10) + '...' : 'Khách hàng' }}
              </div>
              <div class="message-text">{{ message.content }}</div>
              <div class="message-timestamp">{{ message.createdAt | date: 'short' }}</div>
            </div>
          </div>

          <div *ngIf="isLoadingMessages" class="loading-spinner">Đang tải tin nhắn...</div>
        </div>

        <!-- Input box - ĐƯA RA NGOÀI chat-messages để ghim ở cuối -->
        <div class="chat-input-container">
          <div *ngIf="selectedConversation?.status === 'CLOSED'" class="chat-closed-notice">
            <div class="text-muted">Phiên chat đã đóng. Bạn vẫn có thể xem lịch sử nhưng không thể gửi tin nhắn.</div>
          </div>
          <div class="chat-input">
            <input
              type="text"
              [(ngModel)]="newMessage"
              (keydown.enter)="sendMessage(); $event.preventDefault()"
              placeholder="Nhập tin nhắn..."
              class="form-control"
              [disabled]="!isConnected || !selectedConversation || selectedConversation.status === 'CLOSED'"
            />
            <button
              class="btn btn-primary"
              (click)="sendMessage()"
              [disabled]="!isConnected || newMessage.trim() === '' || !selectedConversation || selectedConversation.status === 'CLOSED'"
            >
              Gửi
            </button>
          </div>
        </div>
      </div>

      <ng-template #noSelection>
        <div class="no-chat-selected">
          <fa-icon [icon]="activeTab === 'CHAT' ? 'comments' : 'envelope'"></fa-icon>
          <h3>Chọn một {{ activeTab === 'CHAT' ? 'cuộc trò chuyện' : 'ticket' }} để bắt đầu.</h3>
        </div>
      </ng-template>
    </div>
  </div>
</div>
