<div class="customer-support-container">
  <div class="header">
    <h2><fa-icon icon="headset"></fa-icon> Chăm Sóc Khách Hàng</h2>
    <div class="connection-status" [class.connected]="isConnected">
      <fa-icon [icon]="isConnected ? 'circle' : 'circle-xmark'"></fa-icon>
      {{ isConnected ? 'Đã kết nối' : 'Mất kết nối' }}
    </div>
  </div>

  <div class="support-layout">
    <!-- Sidebar: Danh sách tickets -->
    <div class="conversations-sidebar">
      <div class="sidebar-header">
        <h3>Phiếu hỗ trợ</h3>
        <span class="conversation-count">{{ tickets.length }}</span>
      </div>

      <div class="conversations-list">
        @if (tickets.length === 0) {
          <div class="empty-state">
            <fa-icon icon="inbox" size="2x"></fa-icon>
            <p>Chưa có phiếu hỗ trợ</p>
          </div>
        } @else {
          @for (ticket of tickets; track ticket.id) {
            <div
              class="conversation-item"
              [class.active]="selectedTicket?.id === ticket.id"
              (click)="selectTicket(ticket)">
              <div class="conversation-avatar">
                <fa-icon icon="user-circle" size="2x"></fa-icon>
              </div>
              <div class="conversation-info">
                <div class="conversation-name">{{ ticket.userEmail }}</div>
                <div class="conversation-preview">{{ ticket.title }}</div>
              </div>
              <div class="conversation-meta">
                @if (ticket.unreadCount && ticket.unreadCount > 0) {
                  <div class="unread-badge">{{ ticket.unreadCount }}</div>
                }
              </div>
            </div>
          }
        }
      </div>
    </div>

    <!-- Main chat area -->
    <div class="chat-area">
      @if (selectedTicket) {
        <div class="chat-header">
          <div class="chat-user-info">
            <fa-icon icon="user-circle" size="lg"></fa-icon>
            <div>
              <div class="chat-user-name">{{ selectedTicket.userEmail }}</div>
              <div class="chat-user-status">
                <fa-icon icon="ticket-alt"></fa-icon> Phiếu #{{ selectedTicket.id }} - {{ selectedTicket.status }}
              </div>
            </div>
          </div>
          <button class="btn btn-sm btn-danger" (click)="closeTicket(selectedTicket.id)">
            <fa-icon icon="times-circle"></fa-icon> Đóng phiếu
          </button>
        </div>

        <div #chatMessagesContainer class="chat-messages">
          @if(isLoadingMessages) {
            <div class="loading-indicator">Đang tải tin nhắn...</div>
          }
          @for (message of messages; track $index) {
            <div class="message" [class.from-admin]="message.isFromAdmin" [class.from-user]="!message.isFromAdmin">
              <div class="message-avatar">
                <fa-icon [icon]="message.isFromAdmin ? 'user-tie' : 'user'"></fa-icon>
              </div>
              <div class="message-content">
                <div class="message-sender">{{ message.isFromAdmin ? (message.senderEmail | slice:0:10) + '...' : 'Khách hàng' }}</div>
                <div class="message-text">{{ message.message }}</div>
                <div class="message-time">{{ message.createdAt | date: 'HH:mm' }}</div>
              </div>
            </div>
          }
        </div>

        <div class="chat-input">
          <input
            type="text"
            [(ngModel)]="newMessage"
            (keyup.enter)="sendMessage()"
            [disabled]="!isConnected"
            placeholder="Nhập tin nhắn..."
            class="form-control" />
          <button
            class="btn btn-primary"
            (click)="sendMessage()"
            [disabled]="!isConnected || newMessage.trim() === ''">
            <fa-icon icon="paper-plane"></fa-icon>
          </button>
        </div>
      } @else {
        <div class="no-chat-selected">
          <fa-icon icon="comments" size="3x"></fa-icon>
          <h3>Chọn một phiếu hỗ trợ</h3>
          <p>Chọn một phiếu từ danh sách bên trái để bắt đầu trò chuyện.</p>
        </div>
      }
    </div>
  </div>
</div>
