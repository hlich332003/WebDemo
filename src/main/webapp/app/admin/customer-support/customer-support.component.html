<div class="customer-support-container">
  <div class="sidebar">
    <div class="sidebar-header">
      <h3 class="sidebar-title">Cuộc trò chuyện</h3>
      <div class="connection-status" [class.connected]="isConnected">
        <fa-icon [icon]="isConnected ? 'circle' : 'circle-xmark'"></fa-icon>
        {{ isConnected ? 'Đã kết nối' : 'Mất kết nối' }}
      </div>
      <span class="conversation-count">{{ conversations.length }}</span>
    </div>
    <div class="conversation-list">
      @if (conversations.length === 0) {
        <div class="no-conversations">Chưa có cuộc trò chuyện nào.</div>
      } @else {
        @for (convo of conversations; track convo.id) {
          <div class="conversation-item" [class.active]="selectedConversation?.id === convo.id" (click)="selectConversation(convo)">
            <div class="conversation-info">
              <div class="user-identifier">{{ convo.userIdentifier }}</div>
              <div class="last-message-time">{{ convo.lastMessageAt | date: 'shortTime' }}</div>
            </div>
            @if (convo.unreadCount > 0) {
              <span class="unread-badge">{{ convo.unreadCount }}</span>
            }
          </div>
        }
      }
    </div>
  </div>

  <div class="chat-window">
    @if (selectedConversation) {
      <div class="chat-header">
        <div class="chat-user-info">
          <div class="chat-user-name">{{ selectedConversation.userIdentifier }}</div>
          <div class="chat-ticket-info">
            <fa-icon icon="comments"></fa-icon> Cuộc trò chuyện #{{ selectedConversation.id }} - {{ selectedConversation.status }}
          </div>
        </div>
        <div class="chat-actions">
          <button class="btn btn-sm btn-danger" (click)="closeConversation(selectedConversation.id)">
            <fa-icon icon="times-circle"></fa-icon> Đóng
          </button>
        </div>
      </div>

      <div class="chat-messages" #chatMessagesContainer>
        @for (message of messages; track message.id) {
          <div
            class="message"
            [class.from-admin]="message.senderType === 'CSKH' || message.senderType === 'ADMIN'"
            [class.from-user]="message.senderType === 'USER'"
          >
            <div class="message-avatar">
              <fa-icon [icon]="message.senderType === 'CSKH' || message.senderType === 'ADMIN' ? 'user-tie' : 'user'"></fa-icon>
            </div>
            <div class="message-content">
              <div class="message-sender">
                {{ message.senderType !== 'USER' ? (message.senderIdentifier | slice: 0 : 10) + '...' : 'Khách hàng' }}
              </div>
              <div class="message-text">{{ message.content }}</div>
              <div class="message-timestamp">{{ message.createdAt | date: 'short' }}</div>
            </div>
          </div>
        }
        @if (isLoadingMessages) {
          <div class="loading-spinner">Đang tải tin nhắn...</div>
        }
      </div>

      <div class="chat-input">
        <textarea
          [(ngModel)]="newMessage"
          (keydown.enter)="sendMessage(); $event.preventDefault()"
          placeholder="Nhập tin nhắn..."
          class="form-control"
          [disabled]="!isConnected"
        ></textarea>
        <button class="btn btn-primary" (click)="sendMessage()" [disabled]="!isConnected || newMessage.trim() === ''">Gửi</button>
      </div>
    } @else {
      <div class="no-chat-selected">
        <p>Chọn một cuộc trò chuyện để bắt đầu.</p>
      </div>
    }
  </div>
</div>
