<nav data-cy="navbar" class="navbar navbar-dark navbar-expand-lg">
  <div class="container-fluid">
    <!-- Brand -->
    <!-- account() signal accessible in template -->
    <a class="navbar-brand" [routerLink]="account()?.authorities?.includes('ROLE_ADMIN') ? '/admin' : '/'" (click)="collapseNavbar()">
      <fa-icon icon="shopping-cart" class="brand-icon"></fa-icon>
      <span class="navbar-title">PC No.1</span>
      <span class="navbar-version">{{ version }}</span>
    </a>

    <!-- Search Form -->
    <form class="search-form" (ngSubmit)="search()">
      <div class="search-container">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          name="searchTerm"
          placeholder="Tìm kiếm sản phẩm..."
          class="search-input"
          (input)="onSearchInput($event)"
        />

        <button type="button" class="search-clear" *ngIf="searchTerm" (click)="clearSearch()">
          <fa-icon icon="times"></fa-icon>
        </button>

        <button type="submit" class="btn-search" [disabled]="isSearching">
          <fa-icon *ngIf="!isSearching" icon="search"></fa-icon>
          <span *ngIf="isSearching" class="spinner-border spinner-border-sm"></span>
        </button>
      </div>
    </form>

    <!-- Mobile Toggle -->
    <button
      class="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbarNav"
      (click)="toggleNavbar()"
      [attr.aria-expanded]="!isNavbarCollapsed()"
    >
      <fa-icon icon="bars" class="navbar-toggler-icon"></fa-icon>
    </button>

    <!-- Navigation Menu -->
    <div class="collapse navbar-collapse" id="navbarNav" [ngbCollapse]="isNavbarCollapsed()">
      <ul class="navbar-nav ms-auto">
        <!-- Home -->
        <li class="nav-item" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">
          <a class="nav-link" [routerLink]="account()?.authorities?.includes('ROLE_ADMIN') ? '/admin' : '/'" (click)="collapseNavbar()">
            <fa-icon icon="home" class="nav-icon"></fa-icon>
            <span class="nav-text">Trang chủ</span>
          </a>
        </li>

        <!-- Wishlist (hidden for admin and guest) -->
        <li *ngIf="showCart() && account()" class="nav-item wishlist-item" routerLinkActive="active">
          <a class="nav-link" routerLink="/wishlist" (click)="collapseNavbar()">
            <fa-icon icon="heart" class="nav-icon"></fa-icon>
            <span class="nav-text">Yêu thích</span>
            <span class="cart-badge" *ngIf="wishlistItemCount > 0">{{ wishlistItemCount }}</span>
          </a>
        </li>

        <!-- Cart (hidden for admin and guest) -->
        <li *ngIf="showCart() && account()" class="nav-item cart-item" routerLinkActive="active">
          <a class="nav-link" routerLink="/cart" (click)="collapseNavbar()">
            <fa-icon icon="shopping-cart" class="nav-icon"></fa-icon>
            <span class="nav-text">Giỏ hàng</span>
            <span class="cart-badge" *ngIf="cartItemCount > 0">{{ cartItemCount }}</span>
          </a>
        </li>

        <!-- Notifications -->
        <li ngbDropdown class="nav-item dropdown notification-item" *ngIf="account()">
          <a class="nav-link" ngbDropdownToggle href="javascript:void(0);" id="notification-menu">
            <fa-icon icon="bell" class="nav-icon"></fa-icon>
            <span class="nav-text d-none d-lg-inline"></span>
            <span class="notification-badge" *ngIf="((unreadCount$ | async) || 0) > 0">{{ unreadCount$ | async }}</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end notification-dropdown" ngbDropdownMenu aria-labelledby="notification-menu">
            <li class="dropdown-header d-flex justify-content-between align-items-center">
              <strong>Thông báo</strong>
              <div class="notification-actions" *ngIf="(notifications$ | async)?.length! > 0">
                <button class="btn-action btn-mark-read" (click)="markAllAsRead()" title="Đánh dấu tất cả là đã đọc">
                  <fa-icon icon="check-double"></fa-icon>
                  <span>Đọc tất cả</span>
                </button>
                <button class="btn-action btn-delete-read" (click)="deleteReadNotifications()" title="Xóa thông báo đã đọc">
                  <fa-icon icon="trash"></fa-icon>
                  <span>Xóa đã đọc</span>
                </button>
              </div>
            </li>
            <li class="notification-divider"></li>
            <div class="notification-list" [class.empty]="(notifications$ | async)?.length === 0">
              <li *ngFor="let notification of notifications$ | async" class="notification-item-wrapper">
                <a
                  class="dropdown-item notification-item-link"
                  [class.unread]="!notification.read"
                  (click)="markAsRead(notification)"
                  href="javascript:void(0);"
                >
                  <div class="notification-content">
                    <p class="notification-message">{{ notification.message }}</p>
                    <small class="notification-time">{{ notification.timestamp | notificationDate | formatMediumDatetime }}</small>
                  </div>
                  <button class="btn-delete-notification" (click)="deleteNotification($event, notification)" title="Xóa thông báo này">
                    <fa-icon icon="times" size="sm"></fa-icon>
                  </button>
                </a>
              </li>
              <li *ngIf="(notifications$ | async)?.length === 0" class="dropdown-item text-center text-muted">
                <fa-icon icon="bell-slash" class="me-2"></fa-icon>
                <small>Không có thông báo nào</small>
              </li>
            </div>
          </ul>
        </li>

        <!-- jhipster-needle-add-element-to-menu - JHipster will add new menu items here -->
        <li
          *jhiHasAnyAuthority="'ROLE_ADMIN'"
          ngbDropdown
          class="nav-item dropdown pointer"
          display="dynamic"
          routerLinkActive="active"
          [routerLinkActiveOptions]="{ exact: true }"
        >
          <a class="nav-link dropdown-toggle" ngbDropdownToggle href="javascript:void(0);" id="entity-menu" data-cy="entity">
            <span>
              <fa-icon icon="th-list"></fa-icon>
              <span>Quản lý</span>
            </span>
          </a>
          <ul class="dropdown-menu" ngbDropdownMenu aria-labelledby="entity-menu">
            <li>
              <a class="dropdown-item" routerLink="/admin/product-management" routerLinkActive="active" (click)="collapseNavbar()">
                <fa-icon icon="box-open" [fixedWidth]="true"></fa-icon>
                <span>Quản lý sản phẩm</span>
              </a>
            </li>
            <li>
              <a class="dropdown-item" routerLink="/admin/order-management" routerLinkActive="active" (click)="collapseNavbar()">
                <fa-icon icon="receipt" [fixedWidth]="true"></fa-icon>
                <span>Quản lý đơn hàng</span>
              </a>
            </li>
            <li>
              <a class="dropdown-item" routerLink="/admin/review-management" routerLinkActive="active" (click)="collapseNavbar()">
                <fa-icon icon="star" [fixedWidth]="true"></fa-icon>
                <span>Quản lý đánh giá</span>
              </a>
            </li>
            <li>
              <a class="dropdown-item" routerLink="/admin/user-management" routerLinkActive="active" (click)="collapseNavbar()">
                <span>Quản lý người dùng</span>
              </a>
            </li>
            <li>
              <a class="dropdown-item" routerLink="/admin/customer-support" routerLinkActive="active" (click)="collapseNavbar()">
                <fa-icon icon="headset" [fixedWidth]="true"></fa-icon>
                <span>Hỗ trợ khách hàng</span>
              </a>
            </li>
            <!-- jhipster-needle-add-entity-to-menu - JHipster will add entities to the menu here -->
          </ul>
        </li>
        <li
          ngbDropdown
          class="nav-item dropdown pointer"
          display="dynamic"
          routerLinkActive="active"
          [routerLinkActiveOptions]="{ exact: true }"
        >
          <a class="nav-link dropdown-toggle" ngbDropdownToggle href="javascript:void(0);" id="account-menu" data-cy="accountMenu">
            <ng-container *ngIf="!account()?.imageUrl; else avatar">
              <span>
                <fa-icon icon="user"></fa-icon>
                <span>Tài khoản</span>
              </span>
            </ng-container>
            <ng-template #avatar>
              <span>
                <img [ngSrc]="account()!.imageUrl || ''" class="profile-image rounded-circle" alt="Avatar" width="28" height="28" />
              </span>
            </ng-template>
          </a>
          <ul class="dropdown-menu" ngbDropdownMenu aria-labelledby="account-menu">
            <ng-container *ngIf="account() as acc; else guestMenu">
              <li *jhiHasAnyAuthority="'ROLE_USER'">
                <ng-container *ngIf="!acc.authorities.includes('ROLE_ADMIN')">
                  <a
                    class="dropdown-item"
                    routerLink="/account/my-orders"
                    routerLinkActive="active"
                    (click)="collapseNavbar()"
                    data-cy="myOrders"
                  >
                    <fa-icon icon="receipt" [fixedWidth]="true"></fa-icon>
                    <span>Đơn hàng của tôi</span>
                  </a>
                </ng-container>
              </li>
              <li>
                <a
                  class="dropdown-item"
                  routerLink="/account/settings"
                  routerLinkActive="active"
                  (click)="collapseNavbar()"
                  data-cy="settings"
                >
                  <fa-icon icon="wrench" [fixedWidth]="true"></fa-icon>
                  <span>Cài đặt</span>
                </a>
              </li>
              <li>
                <a
                  class="dropdown-item"
                  routerLink="/account/password"
                  routerLinkActive="active"
                  (click)="collapseNavbar()"
                  data-cy="passwordItem"
                >
                  <fa-icon icon="lock" [fixedWidth]="true"></fa-icon>
                  <span>Mật khẩu</span>
                </a>
              </li>
              <li>
                <a class="dropdown-item" (click)="logout()" id="logout" data-cy="logout">
                  <fa-icon icon="sign-out-alt" [fixedWidth]="true"></fa-icon>
                  <span>Đăng xuất</span>
                </a>
              </li>
            </ng-container>
            <ng-template #guestMenu>
              <li>
                <a class="dropdown-item" (click)="login()" id="login" data-cy="login">
                  <fa-icon icon="sign-in-alt" [fixedWidth]="true"></fa-icon>
                  <span>Đăng nhập</span>
                </a>
              </li>
              <li>
                <a
                  class="dropdown-item"
                  routerLink="/account/register"
                  routerLinkActive="active"
                  (click)="collapseNavbar()"
                  data-cy="register"
                >
                  <fa-icon icon="user-plus" [fixedWidth]="true"></fa-icon>
                  <span>Đăng ký</span>
                </a>
              </li>
            </ng-template>
          </ul>
        </li>
      </ul>
    </div>
  </div>
  <!-- Notification container -->
  <div id="notification" class="notification hidden" aria-live="polite"></div>
</nav>
