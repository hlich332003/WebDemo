<div class="chat-widget-container">
  <button class="chat-toggle-button" (click)="toggleChat()">
    <fa-icon [icon]="isOpen ? 'times' : 'comments'"></fa-icon>
    @if (hasUnreadMessages && !isOpen) {
      <span class="notification-badge"></span>
    }
  </button>

  @if (isOpen) {
    <div class="chat-window">
      <div class="chat-header">
        <div class="header-content">
          <h5>H·ªó tr·ª£ tr·ª±c tuy·∫øn</h5>
          <div class="status" [class.connected]="webSocketService.isConnected">
            <fa-icon icon="circle"></fa-icon>
            {{ webSocketService.isConnected ? 'ƒê√£ k·∫øt n·ªëi' : 'ƒêang k·∫øt n·ªëi...' }}
          </div>
        </div>
        <button class="close-button" (click)="toggleChat()">
          <fa-icon icon="times"></fa-icon>
        </button>
      </div>

      <!-- M√†n h√¨nh 1: Menu L·ª±a ch·ªçn -->
      @if (viewMode === 'MENU') {
        <div class="menu-view">
          <div class="welcome-text">
            <h6>Xin ch√†o! üëã</h6>
            <p>Ch√∫ng t√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay?</p>
          </div>

          <div class="menu-options">
            <button class="menu-btn" (click)="startDirectChat()">
              <div class="icon-wrapper chat-icon">
                <fa-icon icon="comments"></fa-icon>
              </div>
              <div class="text-wrapper">
                <span class="title">Chat ngay</span>
                <span class="desc">Tr√≤ chuy·ªán tr·ª±c ti·∫øp v·ªõi nh√¢n vi√™n</span>
              </div>
              <fa-icon icon="chevron-right" class="arrow"></fa-icon>
            </button>

            <button class="menu-btn" (click)="showCreateTicketForm()">
              <div class="icon-wrapper ticket-icon">
                <fa-icon icon="envelope"></fa-icon>
              </div>
              <div class="text-wrapper">
                <span class="title">T·∫°o phi·∫øu h·ªó tr·ª£</span>
                <span class="desc">G·ª≠i y√™u c·∫ßu chi ti·∫øt qua email</span>
              </div>
              <fa-icon icon="chevron-right" class="arrow"></fa-icon>
            </button>
          </div>
        </div>
      }

      <!-- M√†n h√¨nh 2: Form T·∫°o Phi·∫øu -->
      @if (viewMode === 'CREATE_TICKET') {
        <div class="create-ticket-view">
          <div class="view-header">
            <button class="back-btn" (click)="backToMenu()">
              <fa-icon icon="arrow-left"></fa-icon>
            </button>
            <h6>T·∫°o phi·∫øu m·ªõi</h6>
          </div>

          <div class="form-body">
            <div class="form-group">
              <label>Ti√™u ƒë·ªÅ <span class="required">*</span></label>
              <input type="text" [(ngModel)]="ticketTitle" class="form-control" placeholder="T√≥m t·∫Øt v·∫•n ƒë·ªÅ...">
            </div>

            <div class="form-group">
              <label>N·ªôi dung <span class="required">*</span></label>
              <textarea [(ngModel)]="ticketDescription" class="form-control" rows="5" placeholder="M√¥ t·∫£ chi ti·∫øt..."></textarea>
            </div>

            <button class="btn-submit" (click)="createTicket()" [disabled]="isCreatingTicket || !ticketTitle || !ticketDescription">
              @if (isCreatingTicket) {
                <fa-icon icon="spinner" spin></fa-icon> ƒêang g·ª≠i...
              } @else {
                G·ª≠i y√™u c·∫ßu
              }
            </button>
          </div>
        </div>
      }

      <!-- M√†n h√¨nh 3: Chat -->
      @if (viewMode === 'CHAT') {
        <div #chatMessagesContainer class="chat-body">
          @if (isLoading) {
            <div class="loading-indicator">
              <fa-icon icon="spinner" spin></fa-icon>
              <p>ƒêang t·∫£i cu·ªôc tr√≤ chuy·ªán...</p>
            </div>
          }

          @if (messages.length === 0) {
            <div class="empty-chat">
              <p>üëã Xin ch√†o! H√£y ƒë·ªÉ l·∫°i l·ªùi nh·∫Øn, ch√∫ng t√¥i s·∫Ω ph·∫£n h·ªìi s·ªõm nh·∫•t.</p>
            </div>
          }

          @for (msg of messages; track $index) {
            <div class="message" [ngClass]="{'from-admin': msg.isFromAdmin, 'from-user': !msg.isFromAdmin, 'system-message': msg.type === 'system'}">
              @if (msg.type !== 'system') {
                <div class="message-avatar">
                  <fa-icon [icon]="msg.isFromAdmin ? 'user-tie' : 'user'"></fa-icon>
                </div>
              }
              <div class="message-content">
                <div class="message-text">{{ msg.message }}</div>
                <div class="message-time">{{ msg.timestamp | date:'HH:mm' }}</div>
              </div>
            </div>
          }
        </div>

        <div class="chat-footer">
          @if (sessionEnded) {
            <div class="session-ended-notice">Phi√™n h·ªó tr·ª£ ƒë√£ k·∫øt th√∫c.</div>
          } @else {
            <input
              type="text"
              class="chat-input"
              placeholder="Nh·∫≠p tin nh·∫Øn..."
              [(ngModel)]="newMessage"
              (keyup.enter)="sendMessage()"
              [disabled]="!webSocketService.isConnected"
            />
            <button class="send-button" (click)="sendMessage()" [disabled]="!newMessage.trim() || !webSocketService.isConnected">
              <fa-icon icon="paper-plane"></fa-icon>
            </button>
          }
        </div>
      }
    </div>
  }
</div>
