<div class="chat-widget-container">
  <button class="chat-toggle-button" (click)="toggleChat()">
    <fa-icon [icon]="isOpen ? 'times' : 'comments'"></fa-icon>
    <span *ngIf="hasUnreadMessages && !isOpen" class="notification-badge"></span>
  </button>

  <div *ngIf="isOpen" class="chat-window">
    <div class="chat-header">
      <div class="header-content">
        <h5>H·ªó tr·ª£ tr·ª±c tuy·∫øn</h5>
        <div class="status" [class.connected]="isConnected">
          <fa-icon icon="circle"></fa-icon>
          {{ isConnected ? 'ƒê√£ k·∫øt n·ªëi' : 'ƒêang k·∫øt n·ªëi...' }}
        </div>
      </div>
      <div class="header-actions">
        <button class="minimize-button" (click)="minimizeChat()" title="Thu nh·ªè">
          <fa-icon icon="minus"></fa-icon>
        </button>
        <button class="close-button" (click)="closeChat()" title="ƒê√≥ng">
          <fa-icon icon="times"></fa-icon>
        </button>
      </div>
    </div>

    <!-- M√†n h√¨nh 1: Menu L·ª±a ch·ªçn -->
    <div *ngIf="viewMode === 'MENU'" class="menu-view">
      <div class="welcome-text">
        <h6>Xin ch√†o! üëã</h6>
        <p>Ch√∫ng t√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay?</p>
      </div>
      <div *ngIf="isLoading" class="loading-indicator"><fa-icon icon="spinner" [class.fa-spin]="true"></fa-icon> ƒêang x·ª≠ l√Ω...</div>
      <div class="menu-options" *ngIf="!isLoading">
        <button class="menu-btn" (click)="initiateChat()">
          <div class="icon-wrapper chat-icon">
            <fa-icon icon="comments"></fa-icon>
          </div>
          <div class="text-wrapper">
            <span class="title">Chat tr·ª±c ti·∫øp</span>
            <span class="desc">Tr√≤ chuy·ªán tr·ª±c ti·∫øp v·ªõi nh√¢n vi√™n</span>
          </div>
          <fa-icon icon="chevron-right" class="arrow"></fa-icon>
        </button>

        <button class="menu-btn" (click)="showCreateTicketForm()">
          <div class="icon-wrapper ticket-icon">
            <fa-icon icon="envelope"></fa-icon>
          </div>
          <div class="text-wrapper">
            <span class="title">G·ª≠i y√™u c·∫ßu h·ªó tr·ª£</span>
            <span class="desc">T·∫°o ticket ƒë·ªÉ theo d√µi v·∫•n ƒë·ªÅ</span>
          </div>
          <fa-icon icon="chevron-right" class="arrow"></fa-icon>
        </button>

        <button class="menu-btn" (click)="showHistory()">
          <div class="icon-wrapper history-icon">
            <fa-icon icon="history"></fa-icon>
          </div>
          <div class="text-wrapper">
            <span class="title">L·ªãch s·ª≠ h·ªó tr·ª£</span>
            <span class="desc">Xem l·∫°i c√°c y√™u c·∫ßu c≈©</span>
          </div>
          <fa-icon icon="chevron-right" class="arrow"></fa-icon>
        </button>
      </div>
    </div>

    <!-- M√†n h√¨nh 1.5: Form nh·∫≠p th√¥ng tin Guest -->
    <div *ngIf="viewMode === 'GUEST_INFO'" class="create-ticket-view">
      <div class="view-header">
        <button class="back-btn" (click)="backToMenu()">
          <fa-icon icon="arrow-left"></fa-icon>
        </button>
        <h6>Th√¥ng tin c·ªßa b·∫°n</h6>
      </div>
      <div class="form-body">
        <p class="text-muted small">Vui l√≤ng cung c·∫•p email ho·∫∑c SƒêT ƒë·ªÉ ch√∫ng t√¥i c√≥ th·ªÉ h·ªó tr·ª£ b·∫°n t·ªët h∆°n.</p>
        <div class="form-group">
          <label for="guestChatContact">Email ho·∫∑c SƒêT <span class="required">*</span></label>
          <input
            id="guestChatContact"
            type="text"
            [(ngModel)]="guestChatContact"
            class="form-control"
            placeholder="Nh·∫≠p email ho·∫∑c SƒêT..."
          />
        </div>
        <button class="btn-submit" (click)="startDirectChat()" [disabled]="isLoading || !guestChatContact.trim()">
          <fa-icon *ngIf="isLoading" icon="spinner" [class.fa-spin]="true"></fa-icon>
          <span *ngIf="!isLoading">B·∫Øt ƒë·∫ßu chat</span>
        </button>
      </div>
    </div>

    <!-- M√†n h√¨nh 2: Form T·∫°o Phi·∫øu -->
    <div *ngIf="viewMode === 'CREATE_TICKET'" class="create-ticket-view">
      <div class="view-header">
        <button class="back-btn" (click)="backToMenu()">
          <fa-icon icon="arrow-left"></fa-icon>
        </button>
        <h6>T·∫°o phi·∫øu m·ªõi</h6>
      </div>

      <div class="form-body">
        <div class="form-group" *ngIf="!currentUser">
          <label for="ticketContact">Email ho·∫∑c SƒêT c·ªßa b·∫°n <span class="required">*</span></label>
          <input
            id="ticketContact"
            type="text"
            [(ngModel)]="ticketContact"
            class="form-control"
            placeholder="ƒê·ªÉ ch√∫ng t√¥i li√™n h·ªá l·∫°i..."
          />
        </div>
        <div class="form-group">
          <label for="ticketTitle">Ti√™u ƒë·ªÅ <span class="required">*</span></label>
          <input id="ticketTitle" type="text" [(ngModel)]="ticketTitle" class="form-control" placeholder="T√≥m t·∫Øt v·∫•n ƒë·ªÅ..." />
        </div>
        <div class="form-group">
          <label for="ticketDescription">N·ªôi dung <span class="required">*</span></label>
          <textarea
            id="ticketDescription"
            [(ngModel)]="ticketDescription"
            class="form-control"
            rows="5"
            placeholder="M√¥ t·∫£ chi ti·∫øt..."
          ></textarea>
        </div>
        <button
          class="btn-submit"
          (click)="createTicket()"
          [disabled]="isCreatingTicket || !ticketTitle || !ticketDescription || (!currentUser && !ticketContact)"
        >
          <fa-icon *ngIf="isCreatingTicket" icon="spinner" [class.fa-spin]="true"></fa-icon>
          <span *ngIf="!isCreatingTicket">G·ª≠i y√™u c·∫ßu</span>
        </button>
      </div>
    </div>

    <!-- M√†n h√¨nh 2.5: L·ªãch s·ª≠ -->
    <div *ngIf="viewMode === 'HISTORY'" class="history-view">
      <div class="view-header">
        <button class="back-btn" (click)="backToMenu()">
          <fa-icon icon="arrow-left"></fa-icon>
        </button>
        <h6>L·ªãch s·ª≠ h·ªó tr·ª£</h6>
      </div>
      <div class="history-list">
        <div *ngIf="isLoading" class="loading-indicator"><fa-icon icon="spinner" [class.fa-spin]="true"></fa-icon> ƒêang t·∫£i...</div>
        <div *ngIf="!isLoading && myTickets.length === 0" class="empty-history">
          <p>B·∫°n ch∆∞a c√≥ y√™u c·∫ßu h·ªó tr·ª£ n√†o.</p>
        </div>
        <div *ngFor="let ticket of myTickets" class="history-item" (click)="selectTicketFromHistory(ticket)">
          <div class="history-icon">
            <fa-icon [icon]="ticket.title === 'H·ªó tr·ª£ tr·ª±c tuy·∫øn' ? 'comments' : 'envelope'"></fa-icon>
          </div>
          <div class="history-info">
            <div class="history-title">{{ ticket.title || 'H·ªó tr·ª£ tr·ª±c tuy·∫øn' }}</div>
            <div class="history-meta">
              <span class="history-id">#{{ ticket.id }}</span>
              <span class="history-status" [ngClass]="ticket.status.toLowerCase()">{{ ticket.status }}</span>
            </div>
            <div class="history-date">{{ ticket.lastModifiedDate | date: 'short' }}</div>
          </div>
          <fa-icon icon="chevron-right" class="arrow"></fa-icon>
        </div>
      </div>
    </div>

    <!-- M√†n h√¨nh 3: Chat -->
    <div *ngIf="viewMode === 'CHAT'" class="chat-view">
      <div class="view-header">
        <button class="back-btn" (click)="backToMenu()">
          <fa-icon icon="arrow-left"></fa-icon>
        </button>
        <h6>
          {{ currentConversation?.id ? '#' + currentConversation?.id : '' }}
          {{ sessionEnded ? '(ƒê√£ k·∫øt th√∫c)' : '' }}
        </h6>
      </div>
      <div #chatMessagesContainer class="chat-body" (scroll)="onUserScroll()">
        <div *ngIf="isLoading" class="loading-indicator">
          <fa-icon icon="spinner" [class.fa-spin]="true"></fa-icon>
          <p>ƒêang t·∫£i cu·ªôc tr√≤ chuy·ªán...</p>
        </div>
        <div *ngIf="!isLoading && messages.length === 0" class="empty-chat">
          <p>üëã Xin ch√†o! H√£y ƒë·ªÉ l·∫°i l·ªùi nh·∫Øn, ch√∫ng t√¥i s·∫Ω ph·∫£n h·ªìi s·ªõm nh·∫•t.</p>
        </div>
        <div
          *ngFor="let msg of messages"
          class="message"
          [ngClass]="{ 'from-admin': msg.isFromAdmin, 'from-user': !msg.isFromAdmin, 'system-message': msg.type === 'system' }"
        >
          <div class="message-avatar">
            <fa-icon [icon]="msg.isFromAdmin ? 'user-tie' : 'user'"></fa-icon>
          </div>
          <div class="message-content">
            <div class="message-text">{{ msg.content }}</div>
            <div class="message-time">{{ msg.createdAt | date: 'HH:mm' }}</div>
          </div>
        </div>
      </div>

      <div class="chat-footer">
        <div *ngIf="sessionEnded" class="session-ended">
          <div class="session-ended-notice">Phi√™n h·ªó tr·ª£ ƒë√£ k·∫øt th√∫c.</div>
          <button class="btn btn-link" (click)="initiateChat()">T·∫°o phi√™n chat m·ªõi</button>
        </div>
        <div *ngIf="!sessionEnded" class="chat-input-area">
          <input
            type="text"
            class="chat-input"
            [placeholder]="isConnected ? 'Nh·∫≠p tin nh·∫Øn...' : 'ƒêang k·∫øt n·ªëi...'"
            [(ngModel)]="newMessage"
            (keyup.enter)="sendMessage()"
            [disabled]="!isConnected || sessionEnded"
          />
          <button class="send-button" (click)="sendMessage()" [disabled]="!newMessage.trim() || !isConnected || sessionEnded">
            <fa-icon icon="paper-plane"></fa-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
